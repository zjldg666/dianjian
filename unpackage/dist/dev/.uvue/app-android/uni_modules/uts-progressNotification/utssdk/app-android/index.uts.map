{"version":3,"file":"index.uts","sourceRoot":"","sources":["uni_modules/uts-progressNotification/utssdk/app-android/index.uts"],"names":[],"mappings":"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","sourcesContent":["import Build from 'android.os.Build';\r\nimport Context from 'android.content.Context';\r\nimport NotificationManager from 'android.app.NotificationManager';\r\nimport NotificationChannel from 'android.app.NotificationChannel';\r\nimport Notification from 'android.app.Notification';\r\nimport Intent from 'android.content.Intent';\r\nimport ComponentName from 'android.content.ComponentName';\r\nimport PendingIntent from 'android.app.PendingIntent';\r\nimport { CreateNotificationProgressOptions, FinishNotificationProgressOptions } from '../interface.uts';\r\nimport { ACTION_DOWNLOAD_FINISH, ACTION_DOWNLOAD_PROGRESS } from \"./constant.uts\"\r\n\r\nimport { setGlobalNotificationProgressCallBack, setGlobalNotificationProgressFinishCallBack } from './callbacks.uts';\r\n\r\nexport { TransparentActivity } from './TransparentActivity.uts';\r\n\r\n\r\nconst DOWNLOAD_PROGRESS_NOTIFICATION_ID : Int = 7890\r\nconst DC_DOWNLOAD_CHANNEL_ID = \"下载文件\"\r\nconst DC_DOWNLOAD_CHANNEL_NAME = \"用于显示现在进度的渠道\"\r\n\r\n\r\nlet notificationBuilder : Notification.Builder | null = null\r\n\r\nlet timeId = -1\r\n\r\nlet histroyProgress = 0\r\n\r\nlet isProgress = false\r\n\r\n\r\n\r\nexport function createNotificationProgress(options : CreateNotificationProgressOptions) : void {\r\n\tconst { content, progress, onClick } = options\r\n\r\n\tif (progress == 100) {\r\n\t\tclearTimeout(timeId)\r\n\t\tconst context = UTSAndroid.getAppContext() as Context\r\n\t\trealCreateNotificationProgress(options.title ?? getAppName(context), content, progress, onClick)\r\n\t\treset()\r\n\t\treturn\r\n\t}\r\n\r\n\thistroyProgress = progress\r\n\tif (timeId != -1) {\r\n\t\treturn\r\n\t}\r\n\r\n\tconst context = UTSAndroid.getAppContext() as Context\r\n\tif (!isProgress) {\r\n\t\trealCreateNotificationProgress(options.title ?? getAppName(context), content, histroyProgress, onClick)\r\n\t\tisProgress = true\r\n\t} else {\r\n\t\ttimeId = setTimeout(() => {\r\n\t\t\trealCreateNotificationProgress(options.title ?? getAppName(context), content, histroyProgress, onClick)\r\n\t\t\ttimeId = -1\r\n\t\t}, 1000)\r\n\t}\r\n}\r\n\r\n\r\nexport function cancelNotificationProgress() : void {\r\n\tconst context = UTSAndroid.getAppContext() as Context\r\n\tconst notificationManager = context.getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager\r\n\tnotificationManager.cancel(DOWNLOAD_PROGRESS_NOTIFICATION_ID)\r\n\treset()\r\n}\r\n\r\n\r\nfunction realCreateNotificationProgress(title : string, content : string, progress : number, cb : (() => void) | null) : void {\r\n  setGlobalNotificationProgressCallBack(cb)\r\n\tconst context = UTSAndroid.getAppContext() as Context\r\n\tconst notificationManager = context.getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager\r\n\tcreateDownloadChannel(notificationManager)\r\n\tconst builder = createNotificationBuilder(context)\r\n\tbuilder.setProgress(100, progress.toInt(), false)\r\n\tbuilder.setContentTitle(title)\r\n\tbuilder.setContentText(content)\r\n\tbuilder.setContentIntent(createPendingIntent(context, ACTION_DOWNLOAD_PROGRESS));\r\n\tnotificationManager.notify(DOWNLOAD_PROGRESS_NOTIFICATION_ID, builder.build())\r\n}\r\n\r\n\r\nexport function finishNotificationProgress(options : FinishNotificationProgressOptions) {\r\n  setGlobalNotificationProgressFinishCallBack(options.onClick)\r\n\tconst context = UTSAndroid.getAppContext() as Context\r\n\tconst notificationManager = context.getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager\r\n\tcreateDownloadChannel(notificationManager)\r\n\tconst builder = createNotificationBuilder(context)\r\n\tbuilder.setProgress(0, 0, false)\r\n\tbuilder.setContentTitle(options.title ?? getAppName(context))\r\n\tbuilder.setContentText(options.content)\r\n\t//小米rom setOngoing未false的时候，会被通知管理器归为不重要通知\r\n\t// builder.setOngoing(false)\r\n\tbuilder.setAutoCancel(true);\r\n\tbuilder.setContentIntent(createPendingIntent(context, ACTION_DOWNLOAD_FINISH));\r\n\tnotificationManager.notify(DOWNLOAD_PROGRESS_NOTIFICATION_ID, builder.build())\r\n\treset()\r\n}\r\n\r\nfunction reset() {\r\n\tisProgress = false\r\n\tnotificationBuilder = null\r\n\thistroyProgress = 0\r\n\tif (timeId != -1) {\r\n\t\tclearTimeout(timeId)\r\n\t\ttimeId = -1\r\n\t}\r\n}\r\n\r\nfunction createPendingIntent(context : Context, action : string) : PendingIntent {\r\n\tconst intent = new Intent(action);\r\n\tintent.setComponent(new ComponentName(context.getPackageName(), \"uts.sdk.modules.utsProgressNotification.TransparentActivity\"));\r\n\tlet flags = PendingIntent.FLAG_UPDATE_CURRENT;\r\n\tif (Build.VERSION.SDK_INT >= 23) {\r\n\t\tflags = PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE;\r\n\t}\r\n\treturn PendingIntent.getActivity(context, DOWNLOAD_PROGRESS_NOTIFICATION_ID, intent, flags);\r\n}\r\n\r\nfunction createDownloadChannel(notificationManager : NotificationManager) {\r\n\tif (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {\r\n\t\tconst channel = new NotificationChannel(\r\n\t\t\tDC_DOWNLOAD_CHANNEL_ID,\r\n\t\t\tDC_DOWNLOAD_CHANNEL_NAME,\r\n\t\t\tNotificationManager.IMPORTANCE_LOW\r\n\t\t)\r\n\t\tnotificationManager.createNotificationChannel(channel)\r\n\t}\r\n}\r\n@Suppress(\"DEPRECATION\")\r\nfunction createNotificationBuilder(context : Context) : Notification.Builder {\r\n\tif (notificationBuilder == null) {\r\n\t\tif (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {\r\n\t\t\tnotificationBuilder = new Notification.Builder(context, DC_DOWNLOAD_CHANNEL_ID)\r\n\t\t} else {\r\n\t\t\tnotificationBuilder = new Notification.Builder(context)\r\n\t\t}\r\n\t\tnotificationBuilder!.setSmallIcon(context.getApplicationInfo().icon)\r\n\t\tnotificationBuilder!.setOngoing(true)\r\n\t\tnotificationBuilder!.setSound(null)\r\n\t}\r\n\treturn notificationBuilder!\r\n}\r\n\r\n@Suppress(\"DEPRECATION\")\r\nfunction getAppName(context : Context) : string {\r\n\tlet appName = \"\"\r\n\ttry {\r\n\t\tconst packageManager = context.getPackageManager()\r\n\t\tconst applicationInfo = packageManager.getApplicationInfo(context.getPackageName(), 0)\r\n\t\tappName = packageManager.getApplicationLabel(applicationInfo) as string\r\n\t} catch (e : Exception) {\r\n\t\te.printStackTrace()\r\n\t}\r\n\treturn appName\r\n}\r\n"]}